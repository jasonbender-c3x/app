I've created the requested markdown file, `RAG_AND_ROBUSTNESS_ISSUES.md`, outlining the immediate issues found in your **Nebula Chat** repository.

This file starts with the critical PDF ingestion problem and moves on to robustness and data integrity fixes.

```markdown
# üõ†Ô∏è Issues to Fix in Nebula Chat (RAG and Robustness)

This document lists design, robustness, and data integrity problems identified in the Nebula Chat RAG pipeline and database schema, prioritized by impact.

---

## üéØ P0: Critical RAG Functionality & Data Integrity

### 1. Enable PDF and Binary Document Ingestion

**Module:** `server/services/rag-service.ts`, `server/services/chunking-service.ts`

**Problem:** The `RAGService.processAttachment` function explicitly filters out non-text MIME types, preventing files like PDFs (`application/pdf`) from entering the RAG pipeline. Without a text extraction step, key document types are unusable.

**Action:**
1.  **Add Text Extraction:** Integrate a library (e.g., `pdf-parse` or similar) to handle text extraction for common binary formats (`application/pdf`, `.docx`).
2.  **Update Filter:** Modify `RAGService.processAttachment` to allow MIME types where text extraction is supported (e.g., `application/pdf`).
3.  **Update `ChunkingService.extractText`**: Integrate the new extraction logic here.

---

## üìà P1: Database Performance and Integrity Fixes

### 2. Migrate JSON Fields to `JSONB`

**Module:** `shared/schema.ts`

**Problem:** Columns designed to hold JSON data use the PostgreSQL `TEXT` type, such as `messages.metadata`, `toolTasks.payload`, and `toolTasks.result`. This forces manual JSON parsing in application code and prevents efficient querying or indexing on the JSON structure.

**Action:**
* Migrate all JSON storage fields to `jsonb` type for better performance, indexing, and runtime validation.

### 3. Fix Data Type for Attachment Size

**Module:** `shared/schema.ts`

**Problem:** The `attachments.size` column is defined as `text("size")`. File size is a numeric metric and should not be stored as a string.

**Action:**
* Change `attachments.size` from `text` to **`integer`** or **`bigint`** (to support very large files) to allow for correct mathematical operations and efficient sorting.

### 4. Enforce Data Integrity for Draft Attachments

**Module:** `shared/schema.ts`

**Problem:** The link between `attachments` and `drafts` via `draftId` is missing a formal foreign key constraint, allowing orphaned attachment records if a draft is deleted.

**Action:**
* Add a foreign key constraint on `attachments.draftId` referencing `drafts.id` with `onDelete: "cascade"` to automatically clean up attachments when their parent draft is removed.

---

## ‚ö†Ô∏è P2: RAG and Dispatch Robustness

### 5. Address Silent File Permission Failures

**Module:** `server/services/rag-dispatcher.ts`

**Problem:** The file writing functions (`processTextFile`, `processBinaryFile`) wrap the `fs.chmod` call in a silent `try...catch` block. If setting permissions fails (e.g., due to user restrictions), the error is not logged or reported in the `DispatchResult`.

**Action:**
* Remove the silent `try...catch` block. Log the error and add a warning message to the `DispatchResult.errors` array when `fs.chmod` fails, ensuring the user is notified that the requested permissions were not applied.

### 6. Improve LLM Output Parsing Fragility

**Module:** `shared/schema.ts`

**Problem:** The parser relies on non-standard, heuristic-based string delimiters (the "Cat Emoji System": `üê±<<<NEBULA`, `üòª<<<`, etc.). This is highly brittle and susceptible to LLM output drift, which can cause intermittent parsing failures.

**Action:**
* Investigate migrating the LLM output structure to rely purely on the native **Gemini function calling feature** for tool calls and file operations. If this is not feasible, replace the emoji heuristics with a simpler, more robust method (e.g., fixed JSON wrapper blocks).
```